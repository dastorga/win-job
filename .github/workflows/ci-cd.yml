name: Application CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "infrastructure/**" # Ignore infrastructure changes
  pull_request:
    branches: [main]
    paths-ignore:
      - "infrastructure/**"

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: southamerica-east1
  REPOSITORY: devops-jobs

jobs:
  test-backend:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Run tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        run: |
          cd backend
          pytest -v

  test-frontend:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run tests
        run: |
          cd frontend
          npm test -- --coverage --watchAll=false

      - name: Build frontend
        run: |
          cd frontend
          npm run build

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

  build-and-deploy:
    if: github.ref == 'refs/heads/main'
    needs: [test-backend, test-frontend, security-scan]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - id: "auth"
        name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: Verify Infrastructure
        run: |
          echo "üîç Verifying that infrastructure exists..."
          # Check if Artifact Registry exists
          if ! gcloud artifacts repositories describe $REPOSITORY --location=$REGION 2>/dev/null; then
            echo "‚ùå Artifact Registry repository not found!"
            echo "üèóÔ∏è Please run infrastructure deployment first on 'integration' branch"
            exit 1
          fi
          echo "‚úÖ Infrastructure verified!"

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker $REGION-docker.pkg.dev

      - name: Build and push backend image
        run: |
          cd backend
          docker build -f ../docker/Dockerfile.backend -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/backend:$GITHUB_SHA .
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/backend:$GITHUB_SHA

          # Tag as latest
          docker tag $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/backend:$GITHUB_SHA $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/backend:latest
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/backend:latest

      - name: Build and push frontend image
        run: |
          cd frontend
          docker build -f ../docker/Dockerfile.frontend -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/frontend:$GITHUB_SHA .
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/frontend:$GITHUB_SHA

          # Tag as latest
          docker tag $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/frontend:$GITHUB_SHA $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/frontend:latest
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/frontend:latest

      - name: Deploy to Cloud Run - Backend
        run: |
          gcloud run deploy devops-jobs-backend \
            --image $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/backend:$GITHUB_SHA \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10

      - name: Deploy to Cloud Run - Frontend
        run: |
          # Get backend URL
          BACKEND_URL=$(gcloud run services describe devops-jobs-backend --region=$REGION --format='value(status.url)')

          gcloud run deploy devops-jobs-frontend \
            --image $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/frontend:$GITHUB_SHA \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 5 \
            --set-env-vars REACT_APP_API_URL=$BACKEND_URL

      - name: Run database migrations
        run: |
          # This would run Alembic migrations if we had them set up
          echo "Database migrations would run here"

  notify-deployment:
    if: github.ref == 'refs/heads/main'
    needs: build-and-deploy
    runs-on: ubuntu-latest

    steps:
      - name: Notify deployment success
        run: |
          echo "üöÄ Deployment completed successfully!"
          echo "Frontend URL: $(gcloud run services describe devops-jobs-frontend --region=$REGION --format='value(status.url)')"
          echo "Backend URL: $(gcloud run services describe devops-jobs-backend --region=$REGION --format='value(status.url)')"
