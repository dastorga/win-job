name: Infrastructure Deployment

on:
  push:
    branches: [integration]
    paths:
      - "infrastructure/**"
  pull_request:
    branches: [integration]
    paths:
      - "infrastructure/**"
  workflow_dispatch: # Allow manual trigger

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: southamerica-east1
  TF_VERSION: "1.6.0"

jobs:
  terraform-validate:
    runs-on: ubuntu-latest
    name: Terraform Validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: |
          cd infrastructure
          terraform fmt -check

      - name: Terraform Init
        run: |
          cd infrastructure
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd infrastructure
          terraform validate

  terraform-plan:
    runs-on: ubuntu-latest
    needs: terraform-validate
    name: Terraform Plan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - id: "auth"
        name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Create Terraform State Bucket (if needed)
        run: |
          # Check if bucket exists, create if not
          if ! gsutil ls gs://win-job-terraform-state-bucket 2>/dev/null; then
            echo "Creating Terraform state bucket..."
            gsutil mb -p $PROJECT_ID -c STANDARD -l $REGION gs://win-job-terraform-state-bucket
            gsutil versioning set on gs://win-job-terraform-state-bucket
          else
            echo "Terraform state bucket already exists"
          fi

      - name: Terraform Init
        run: |
          cd infrastructure
          terraform init \
            -backend-config="bucket=win-job-terraform-state-bucket" \
            -backend-config="prefix=devops-job-scraper"

      - name: Terraform Plan
        run: |
          cd infrastructure
          terraform plan \
            -var="project_id=$PROJECT_ID" \
            -var="region=$REGION" \
            -out=tfplan

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: infrastructure/tfplan

  terraform-apply:
    runs-on: ubuntu-latest
    needs: terraform-plan
    name: Terraform Apply
    if: github.ref == 'refs/heads/integration' && github.event_name == 'push'
    environment: infrastructure # Requires approval for production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - id: "auth"
        name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: infrastructure/

      - name: Terraform Init
        run: |
          cd infrastructure
          terraform init \
            -backend-config="bucket=win-job-terraform-state-bucket" \
            -backend-config="prefix=devops-job-scraper"

      - name: Terraform Apply
        run: |
          cd infrastructure
          terraform apply tfplan

      - name: Get Infrastructure Outputs
        id: terraform-outputs
        run: |
          cd infrastructure
          echo "database_connection_name=$(terraform output -raw database_connection_name)" >> $GITHUB_OUTPUT
          echo "backend_service_url=$(terraform output -raw backend_service_url)" >> $GITHUB_OUTPUT
          echo "frontend_service_url=$(terraform output -raw frontend_service_url)" >> $GITHUB_OUTPUT

      - name: Infrastructure Summary
        run: |
          echo "ğŸ—ï¸ Infrastructure Deployment Completed!"
          echo "ğŸ“Š Database Connection: ${{ steps.terraform-outputs.outputs.database_connection_name }}"
          echo "ğŸ”— Backend URL: ${{ steps.terraform-outputs.outputs.backend_service_url }}"
          echo "ğŸŒ Frontend URL: ${{ steps.terraform-outputs.outputs.frontend_service_url }}"

  security-scan:
    runs-on: ubuntu-latest
    name: Infrastructure Security Scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov (Terraform Security Scanner)
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infrastructure/
          framework: terraform
          output_format: sarif
          output_file_path: checkov-results.sarif

      - name: Upload Checkov scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: checkov-results.sarif

  notify-infrastructure:
    runs-on: ubuntu-latest
    needs: [terraform-apply]
    if: always()
    name: Notify Infrastructure Status

    steps:
      - name: Notify Success
        if: needs.terraform-apply.result == 'success'
        run: |
          echo "âœ… Infrastructure deployment completed successfully!"
          echo "ğŸš€ GCP resources are now available"
          echo "ğŸ“ Check the Terraform outputs for service URLs"

      - name: Notify Failure
        if: needs.terraform-apply.result == 'failure'
        run: |
          echo "âŒ Infrastructure deployment failed!"
          echo "ğŸ” Check the Terraform logs for details"
          exit 1
